<!-- Download button script

When the download button is clicked, disable the button and begin the event stream from the button's make_files function. The make_files function sends progress reports, which update the progress bar. When the event listener received a download_ready message, download the file.
-->

<script>
    $(document).ready(function(){
        $("#{{ btn.btn_id }}").click(function(){
            console.log('Download started');
            $(this).prop('disabled', true);
            handle_form();
        });
    });

    function handle_form(){
        const form_url = "{{ url_for('download_btn.handle_form', id=btn._id, btn_cls=btn.__class__.__name__) }}";
        $.post(form_url, $("{{ btn._form }}").serialize(), function(){
            create_files();
        });
    }

    function create_files(){
        const evtURL = "{{ url_for('download_btn.create_files', id=btn._id, btn_cls=btn.__class__.__name__) }}";
        const evtSource = new EventSource(evtURL);
        evtSource.addEventListener('progress_report', function(e){
            var progress = $.parseJSON(e.data).html;
            $("#{{ btn.progress_id }}").html(progress);
        });
        evtSource.addEventListener('download_ready', function(e){
            evtSource.close();
            download(e);
        });
    }

    function download(e){
        const url = "{{ url_for('download_btn.download', id=btn._id, btn_cls=btn.__class__.__name__) }}";
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        document.body.appendChild(a);
        a.click();
        var download_msg = $.parseJSON(e.data).html;
        $("#{{ btn.progress_id }}").html(download_msg);
        $("#{{ btn.btn_id }}").prop('disabled', false);
        console.log('Download complete'); 
    }
</script>